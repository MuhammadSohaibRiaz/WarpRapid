<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  
  # Disable directory browsing and automatic trailing slashes for directories
  Options -Indexes
  DirectorySlash Off

  # 0. Allow access to _next static files immediately
  RewriteRule ^_next - [L]

  # 1. SPECIAL CASE: Directory/File Conflict Resolution
  # If a request matches a directory, BUT a corresponding .html file exists, serve the file.
  # This fixes the /blog/ vs /blog.html issue.
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteCond %{DOCUMENT_ROOT}/$1.html -f
  RewriteRule ^(.+?)/?$ $1.html [L]

  # 2. Redirect trailing slashes to non-trailing slashes (canonical URLs)
  # Only if it's NOT a real directory (unless handled above)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^(.*)/$ /$1 [L,R=301]

  # 3. Clean URLs: Internally map /path to /path.html
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^(.*)$ $1.html [L]

  # 4. Fallback for 404s
  # If it's not a file or directory, serve the custom 404 page
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  ErrorDocument 404 /404.html

  # Optional: Cache Control
  <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
  </IfModule>
</IfModule>
